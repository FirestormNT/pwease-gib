// Make sure M key also toggles mute/unmute
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'm') {
                toggleMute();
                e.preventDefault();
            }
        });        const characterVideo = document.getElementById('characterVideo');<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pwease Gib</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
            touch-action: none;
        }
        #gameInfo {
            margin: 10px;
            color: white;
        }
        #controls {
            margin: 10px;
        }
   canvas {
    border: 1px solid black;
    max-width: 100%;
    max-height: 80vh;
    transition: border 0.5s ease;
    background-color: #fff;
}   canvas.green-border {
            border: 5px solid green;
        }
     #characterSelect {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    background: none;
    width: 90vw; /* Removed fixed 800px */
    max-height: 80vh; /* Keep max height constraint */
    overflow-y: auto; /* Allow scrolling if content exceeds height */
    z-index: 10;
    padding: 10px; /* Add padding to prevent content from touching edges */
    box-sizing: border-box; /* Include padding in width/height calculations */
}

#videoContainer {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    width: 100%; /* Ensure it fits within parent */
}

#videoTitle {
    font-size: clamp(20px, 4vw, 36px); /* Scale between 20px and 36px based on viewport width */
    font-weight: bold;
    margin-bottom: 1vh; /* Use viewport height units for spacing */
    text-align: center;
    text-shadow: 2px 2px 4px #000;
}

#characterVideo {
    width: clamp(150px, 40vw, 300px); /* Scale between 150px and 300px */
    height: auto;
    margin-bottom: 1vh;
}
        #muteBtn {
            /* Remove specific styling and let it inherit from other buttons */
            margin: 0 5px;
        }
        #characterSelect h2 {
    margin: 1vh 0; /* Adjust spacing with viewport units */
    font-size: clamp(16px, 3vw, 24px); /* Scale header text */
}

#characterOptions {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2vh; /* Use viewport height units for spacing */
    width: 100%; /* Ensure it fits within parent */
}

.character-row {
    display: flex;
    justify-content: center;
    gap: clamp(10px, 4vw, 40px); /* Scale gap between 10px and 40px */
    flex-wrap: wrap; /* Allow wrapping on small screens */
}
        .character-option {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
     .character-option img {
    width: clamp(60px, 15vw, 124px); /* Scale between 60px and 124px */
    height: clamp(60px, 15vw, 124px); /* Maintain square aspect ratio */
    margin-bottom: 1vh;
    cursor: pointer;
    transition: transform 0.2s ease;
}
        .character-option img:hover {
            transform: scale(1.1);
        }
        .character-option.selected {
            outline: 3px solid green;
        }
        #restartBtn, #characterSelectBtn {
            display: none;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            text-align: center;
            background-color: #333;
            border: 1px solid #fff;
            color: white;
            z-index: 10;
        }
        #restartBtn {
            top: 60%;
        }
        #characterSelectBtn {
            top: 70%;
        }
        #controlInfo {
            margin-top: 10px;
            color: white;
            text-align: center;
            font-size: 14px;
        }
        #throwBtn, #powerUpBtn {
            display: none;
            margin-top: 10px;
            padding: 15px 30px;
            font-size: 18px;
            border: 2px solid #fff;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.1s ease, background-color 0.1s ease;
        }
        #throwBtn {
            background-color: #ff5555;
            margin-right: 10px;
        }
        #powerUpBtn {
            background-color: #55ff55;
        }
        #throwBtn:active, #powerUpBtn:active {
            transform: scale(0.95);
        }
        #throwBtn:active {
            background-color: #cc4444;
        }
        #powerUpBtn:active {
            background-color: #44cc44;
        }
        #throwBtn.pressed {
            background-color: #cc4444;
        }
        #powerUpBtn.pressed {
            background-color: #44cc44;
        }
        @media (max-width: 768px) or (pointer: coarse) {
            #throwBtn, #powerUpBtn {
                display: inline-block;
            }
            #throwBtn {
                padding: 20px 60px; /* Twice as big as #powerUpBtn */
                font-size: 24px;
            }
            #powerUpBtn {
                padding: 10px 30px; /* Standard size */
                font-size: 18px;
            }
        }
        #loadingScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 20;
        }
        /* Gamertag Entry Styles */
        #gamertagEntry {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent; /* Changed from rgba(0, 0, 0, 0.9) to transparent */
            z-index: 30;
            color: white;
        }
        #gamertagEntry h2 {
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #000;
            background-color: rgba(0, 0, 0, 0.6); /* Added semi-transparent background */
            padding: 10px 20px;
            border-radius: 5px;
        }
        #gamertagInput {
            padding: 10px 15px;
            font-size: 18px;
            width: clamp(200px, 50vw, 400px);
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #55ff55;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        #gamertagSubmit {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #55ff55;
            border: none;
            border-radius: 5px;
            color: black;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #gamertagSubmit:hover {
            background-color: #44cc44;
        }
        /* We're removing this style since we won't use this element anymore
        #playerGamertagDisplay {
            position: absolute;
            top: 10px;
            left: 20px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            z-index: 15;
        }
        */
    </style>
</head>
<body>
    <div id="loadingScreen">Loading: 0%</div>
    
    <!-- Gamertag Entry Screen -->
    <div id="gamertagEntry">
        <h2>ENTER GAMERTAG</h2>
        <input type="text" id="gamertagInput" maxlength="15" placeholder="Your gamertag...">
        <button id="gamertagSubmit">PLAY</button>
    </div>
    
    <!-- We're removing this element since we'll draw directly on the canvas -->
    <!-- <div id="playerGamertagDisplay"></div> -->
    
    <div id="gameInfo">
        <span id="level">Level: 1</span> |
        <span id="score">Score: 0</span> |
        <span id="highScore">High Score: 0</span> |
        <span id="timer">Timer: 60</span>
    </div>
    <div id="controls">
        <button id="pauseBtn">PAUSE</button>
        <button id="resumeBtn" disabled>RESUME</button>
        <button id="muteBtn">MUTE</button>
        <button id="menuBtn">QUIT</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <button id="throwBtn">Throw</button>
    <button id="powerUpBtn">Item</button> <!-- Renamed to Item -->
    <div id="characterSelect">
        <div id="videoContainer">
            <div id="videoTitle">PWEASE GIB</div>
            <video id="characterVideo" autoplay loop playsinline>
                <!-- Source set via JavaScript -->
            </video>
            <!-- Removed the mute button from character select screen -->
        </div>
        <h2>Choose Your Vance</h2>
        <div id="characterOptions">
            <div class="character-row">
                <div class="character-option">
                    <img src="vancehead2.png" alt="Vance Head" id="vanceHead2Img">
                </div>
                <div class="character-option">
                    <img src="vancewithhat.png" alt="Vance with Hat" id="vanceWithHatImg">
                </div>
                <div class="character-option">
                    <img src="vancegirl.png" alt="Vance Girl" id="vanceGirlImg">
                </div>
                <div class="character-option">
                    <img src="vancesuit.png" alt="Vance Suit" id="vanceSuitImg">
                </div>
            </div>
            <div class="character-row">
                <div class="character-option">
                    <img src="vancehat2.png" alt="Vance Hat 2" id="vanceHat2Img">
                </div>
                <div class="character-option">
                    <img src="vancefat.png" alt="Vance Fat" id="vanceFatImg">
                </div>
                <div class="character-option">
                    <img src="vancechubby.png" alt="Vance Chubby" id="vanceChubbyImg">
                </div>
            </div>
        </div>
    </div>
    <button id="restartBtn">Return to 1st Level</button>
    <button id="characterSelectBtn">Return to Vance Selection</button>
<div id="controlInfo">
    <strong>Controls</strong><br>
    Move Left: A<br>
    Move Right: D<br>
    Throw: Spacebar or Throw Button (Mobile)<br>
    Pause/Resume: P<br>
    Mute/Unmute: M<br>
    Use Item: E or Item Button (Mobile)<br>
    Javelin Control: WASD
</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const menuBtn = document.getElementById('menuBtn');
        const characterSelect = document.getElementById('characterSelect');
        const characterVideo = document.getElementById('characterVideo');
        const vanceHead2ImgElement = document.getElementById('vanceHead2Img');
        const vanceWithHatImgElement = document.getElementById('vanceWithHatImg');
        const vanceGirlImgElement = document.getElementById('vanceGirlImg');
        const vanceSuitImgElement = document.getElementById('vanceSuitImg');
        const vanceHat2ImgElement = document.getElementById('vanceHat2Img');
        const vanceFatImgElement = document.getElementById('vanceFatImg');
        const vanceChubbyImgElement = document.getElementById('vanceChubbyImg');
        const restartBtn = document.getElementById('restartBtn');
        const characterSelectBtn = document.getElementById('characterSelectBtn');
        const muteBtn = document.getElementById('muteBtn');
        const muteIcon = document.getElementById('muteIcon');
        const highScoreDisplay = document.getElementById('highScore');
        const throwBtn = document.getElementById('throwBtn');
        const powerUpBtn = document.getElementById('powerUpBtn');
        const loadingScreen = document.getElementById('loadingScreen');
        
        // Gamertag elements
        const gamertagEntry = document.getElementById('gamertagEntry');
        const gamertagInput = document.getElementById('gamertagInput');
        const gamertagSubmit = document.getElementById('gamertagSubmit');
        // We're not using this element anymore
        // const playerGamertagDisplay = document.getElementById('playerGamertagDisplay');
        
        let playerGamertag = '';

        // Load images
        const vanceHead2Img = new Image();
        vanceHead2Img.src = 'vancehead2.png';
        const vanceWithHatImg = new Image();
        vanceWithHatImg.src = 'vancewithhat.png';
        const vanceGirlImg = new Image();
        vanceGirlImg.src = 'vancegirl.png';
        const vanceSuitImg = new Image();
        vanceSuitImg.src = 'vancesuit.png';
        const vanceHat2Img = new Image();
        vanceHat2Img.src = 'vancehat2.png';
        const vanceFatImg = new Image();
        vanceFatImg.src = 'vancefat.png';
        const vanceChubbyImg = new Image();
        vanceChubbyImg.src = 'vancechubby.png';
        const zelenskyImg = new Image();
        zelenskyImg.src = 'zelenskyhead3.png';
        const putinImg = new Image();
        putinImg.src = 'putinhead.png';
        const lollipopImg = new Image();
        lollipopImg.src = 'lollipop.png';
        const officeImg = new Image();
        officeImg.src = 'officepixel.png';
        const hallwayImg = new Image();
        hallwayImg.src = 'hallway.png';
        const lawnImg = new Image();
        lawnImg.src = 'lawn.png';
        const ballroomImg = new Image();
        ballroomImg.src = 'ballroom.png';
        const bedroomImg = new Image();
        bedroomImg.src = 'bedroom.png';
        const conferenceroomImg = new Image();
        conferenceroomImg.src = 'conferenceroom.png';
        const diningImg = new Image();
        diningImg.src = 'dining.png';
        const trumpImg = new Image();
        trumpImg.src = 'trumphead.png';
        const cybertruckImg = new Image();
        cybertruckImg.src = 'cybertruck.png';
        const explosionImg = new Image();
        explosionImg.src = 'explosion.png';
        const javelinImg = new Image();
        javelinImg.src = 'javelin.png';
        const missileImg = new Image();
        missileImg.src = 'missile.png';
        const hallway2Img = new Image(); // New background
        hallway2Img.src = 'hallway2.png';
        const gameroomImg = new Image(); // New background
        gameroomImg.src = 'gameroom.png';
        const lawn2Img = new Image(); // New background
        lawn2Img.src = 'lawn2.png';

        // Load sound effects
        const selectSound = new Audio('selectsound.wav');
        const explosionSound = new Audio('explosion.wav');
        const shootSound = new Audio('shoot.wav');
        const enlargedSound = new Audio('enlarged.wav');
        const hitSoundPool = [new Audio('hit.wav'), new Audio('hit.wav'), new Audio('hit.wav')];
        let hitSoundIndex = 0;
        const deadSound = new Audio('dead.wav');
        const hoverSound = new Audio('hover.wav');
        const timerSound = new Audio('timer.wav');
        const itemSound = new Audio('item.wav');
        const clapSound = new Audio('clap.wav');
        const pauseSound = new Audio('pause.wav');
        const resumedSound = new Audio('resumed.wav');
        const missileLaunchSound = new Audio('missile_launch1.wav');
        const missileFlyingSound = new Audio('missileflying.wav');

        const backgrounds = [officeImg, hallwayImg, lawnImg, ballroomImg, bedroomImg, conferenceroomImg, diningImg, hallway2Img, gameroomImg, lawn2Img]; // Updated with new backgrounds
        let currentBackgroundIndex = 0;

        let selectedVanceImg = null;
        let gameOverText = null;
        let highScore = localStorage.getItem('highScore') || 0;
        highScoreDisplay.textContent = `High Score: ${highScore}`;
        let currentPowerUp = null;

        // Preload images and set up video
        let imagesLoaded = 0;
        const totalImages = 24; // Updated to 24 with 3 new backgrounds
        function imageLoaded(img) {
            imagesLoaded++;
            loadingScreen.textContent = `Loading: ${Math.floor((imagesLoaded / totalImages) * 100)}%`;
            if (imagesLoaded === totalImages) {
                loadingScreen.style.display = 'none';
                // Show gamertag entry with hallway2 background
                drawHallwayBackground();
                gamertagEntry.style.display = 'flex';
            }
        }
        
        // Function to draw hallway2 background for gamertag entry
        function drawHallwayBackground() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Use hallway2Img as background
            if (hallway2Img.complete) {
                ctx.drawImage(hallway2Img, 0, 0, canvas.width, canvas.height);
            }
        }
        function imageError(img) {
            console.error(`Failed to load image: ${img.src}`);
        }
        vanceHead2Img.onload = () => imageLoaded(vanceHead2Img);
        vanceHead2Img.onerror = () => imageError(vanceHead2Img);
        vanceWithHatImg.onload = () => imageLoaded(vanceWithHatImg);
        vanceWithHatImg.onerror = () => imageError(vanceWithHatImg);
        vanceGirlImg.onload = () => imageLoaded(vanceGirlImg);
        vanceGirlImg.onerror = () => imageError(vanceGirlImg);
        vanceSuitImg.onload = () => imageLoaded(vanceSuitImg);
        vanceSuitImg.onerror = () => imageError(vanceSuitImg);
        vanceHat2Img.onload = () => imageLoaded(vanceHat2Img);
        vanceHat2Img.onerror = () => imageError(vanceHat2Img);
        vanceFatImg.onload = () => imageLoaded(vanceFatImg);
        vanceFatImg.onerror = () => imageError(vanceFatImg);
        vanceChubbyImg.onload = () => imageLoaded(vanceChubbyImg);
        vanceChubbyImg.onerror = () => imageError(vanceChubbyImg);
        zelenskyImg.onload = () => imageLoaded(zelenskyImg);
        zelenskyImg.onerror = () => imageError(zelenskyImg);
        putinImg.onload = () => imageLoaded(putinImg);
        putinImg.onerror = () => imageError(putinImg);
        lollipopImg.onload = () => imageLoaded(lollipopImg);
        lollipopImg.onerror = () => imageError(lollipopImg);
        officeImg.onload = () => imageLoaded(officeImg);
        officeImg.onerror = () => imageError(officeImg);
        hallwayImg.onload = () => imageLoaded(hallwayImg);
        hallwayImg.onerror = () => imageError(hallwayImg);
        lawnImg.onload = () => imageLoaded(lawnImg);
        lawnImg.onerror = () => imageError(lawnImg);
        ballroomImg.onload = () => imageLoaded(ballroomImg);
        ballroomImg.onerror = () => imageError(ballroomImg);
        bedroomImg.onload = () => imageLoaded(bedroomImg);
        bedroomImg.onerror = () => imageError(bedroomImg);
        conferenceroomImg.onload = () => imageLoaded(conferenceroomImg);
        conferenceroomImg.onerror = () => imageError(conferenceroomImg);
        diningImg.onload = () => imageLoaded(diningImg);
        diningImg.onerror = () => imageError(diningImg);
        trumpImg.onload = () => imageLoaded(trumpImg);
        trumpImg.onerror = () => imageError(trumpImg);
        cybertruckImg.onload = () => imageLoaded(cybertruckImg);
        cybertruckImg.onerror = () => imageError(cybertruckImg);
        explosionImg.onload = () => imageLoaded(explosionImg);
        explosionImg.onerror = () => imageError(explosionImg);
        javelinImg.onload = () => imageLoaded(javelinImg);
        javelinImg.onerror = () => imageError(javelinImg);
        missileImg.onload = () => imageLoaded(missileImg);
        missileImg.onerror = () => imageError(missileImg);
        hallway2Img.onload = () => imageLoaded(hallway2Img); // New background
        hallway2Img.onerror = () => imageError(hallway2Img);
        gameroomImg.onload = () => imageLoaded(gameroomImg); // New background
        gameroomImg.onerror = () => imageError(gameroomImg);
        lawn2Img.onload = () => imageLoaded(lawn2Img); // New background
        lawn2Img.onerror = () => imageError(lawn2Img);

        // Gamertag functionality
        gamertagSubmit.addEventListener('click', submitGamertag);
        gamertagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitGamertag();
            }
        });

        function submitGamertag() {
            const gamertag = gamertagInput.value.trim();
            if (gamertag) {
                playerGamertag = gamertag;
                // We don't need this line anymore since we're drawing on canvas
                // playerGamertagDisplay.textContent = playerGamertag;
                
                // Save in localStorage for persistence
                localStorage.setItem('playerGamertag', playerGamertag);
                
                // Hide gamertag entry and show character select
                gamertagEntry.style.display = 'none';
                setupCharacterVideo();
                drawBackground();
                characterSelect.style.display = 'flex';
                initCharacterSelectKeyboard();
            } else {
                // Shake input or show error
                gamertagInput.style.border = '2px solid red';
                setTimeout(() => {
                    gamertagInput.style.border = '2px solid #55ff55';
                }, 1000);
            }
        }

        // Check for saved gamertag on load
        if (localStorage.getItem('playerGamertag')) {
            playerGamertag = localStorage.getItem('playerGamertag');
            gamertagInput.value = playerGamertag;
        }

        // Setup random video selection with mute persistence
        function setupCharacterVideo() {
            const videos = ['vance3d.mp4', 'vance3d2.mp4', 'strobe.mp4', 'retrowave.mp4'];
            const randomVideo = videos[Math.floor(Math.random() * videos.length)];
            characterVideo.innerHTML = '';
            const source = document.createElement('source');
            source.src = randomVideo;
            source.type = 'video/mp4';
            characterVideo.appendChild(source);
            const isMuted = localStorage.getItem('videoMuted') === 'true';
            characterVideo.muted = isMuted;
            updateMuteButtonText(isMuted);
            characterVideo.load();
            characterVideo.play().catch(error => {
                console.error("Video playback failed:", error);
                characterSelect.style.display = 'flex';
            });
        }

        function updateMuteButtonText(isMuted) {
            muteBtn.textContent = isMuted ? "UNMUTE" : "MUTE";
        }

        function toggleMute() {
    // Collect ALL audio elements
    const allAudios = [
        // Music/Video
        characterVideo,
        
        // Sound Effects
        selectSound, 
        explosionSound, 
        shootSound, 
        enlargedSound, 
        deadSound, 
        hoverSound, 
        timerSound, 
        itemSound, 
        clapSound, 
        pauseSound, 
        resumedSound,
        missileLaunchSound, 
        missileFlyingSound,
        
        // Hit Sound Pool
        ...hitSoundPool
    ];
    
    // Check current mute state
    const isMuted = localStorage.getItem('videoMuted') === 'true';
    const newMuteState = !isMuted;
    
    // Apply mute to all audio elements
    allAudios.forEach(audio => {
        // Ensure it's an Audio element before trying to mute
        if (audio && audio.muted !== undefined) {
            audio.muted = newMuteState;
        }
    });
    
    // Update mute button text
    updateMuteButtonText(newMuteState);
    
    // Persist mute state
    localStorage.setItem('videoMuted', newMuteState);
}

// Modify existing mute persistence code
// Check initial mute state from localStorage
const initialMuted = localStorage.getItem('videoMuted') === 'true';
updateMuteButtonText(initialMuted);

// Ensure all initial audio is muted if previously muted
const allInitialAudios = [
    characterVideo,
    selectSound, 
    explosionSound, 
    shootSound, 
    enlargedSound, 
    deadSound, 
    hoverSound, 
    timerSound, 
    itemSound, 
    clapSound, a
    pauseSound, 
    resumedSound,
    missileLaunchSound, 
    missileFlyingSound,
    ...hitSoundPool
];

allInitialAudios.forEach(audio => {
    if (audio && audio.muted !== undefined) {
        audio.muted = initialMuted;
    }
});

muteBtn.addEventListener('click', toggleMute);

// Add global mute key handling
document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'm') {
        toggleMute();
        e.preventDefault();
    }
});

        const BASE_CANVAS_WIDTH = 800;
        let scaleFactor = canvas.width / BASE_CANVAS_WIDTH;

        const player = {
            x: 400,
            baseWidth: 62,
            baseHeight: 62,
            displayWidth: 62 * scaleFactor,
            displayHeight: 62 * scaleFactor,
            targetWidth: 62 * scaleFactor,
            targetHeight: 62 * scaleFactor,
            baseSpeed: 5,
            speed: 5 * scaleFactor,
            text: null,
            textTimer: 0,
            invincible: false,
            invincibleTimer: 0,
            sizeMultiplier: 1,
            sizeTransition: 1,
            sizeTransitionSpeed: 2,
            explosion: null
        };

        let lollipops = [];
        let zelenskyHeads = [];
        let putinHeads = [];
        let trumpHeads = [];
        let cybertrucks = [];
        let javelins = [];
        let missile = null;
        let textEffects = [];
        let level = 1;
        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        let gamePaused = false;
        let levelTransition = false;
        let transitionTimer = 3;
        let gibMoneyTimer = 0;
        let trumpSpawnTimer = 30;
        let cybertruckSpawnTimer = 25;
        let javelinSpawnTimer = 20;
        let lastTrumpSpawnTime = 60;
        let lastCybertruckSpawnTime = 60;
        let lastJavelinSpawnTime = 60;
        let gameTimer = null;
        let animationFrameId = null;

        let touchLeft = false;
        let touchRight = false;

        const levels = [5, 10, 15, 20, 25, 30, 35, 40, 45, 50];

        function easeInOut(t) {
            return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
        }

        function drawBackground() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const currentBackground = backgrounds[currentBackgroundIndex];
            if (currentBackground.complete) {
                ctx.drawImage(currentBackground, 0, 0, canvas.width, canvas.height);
            }
        }

        let selectedCharacterIndex = 0;
        const characterOptions = [
            vanceHead2ImgElement, vanceWithHatImgElement, vanceGirlImgElement, vanceSuitImgElement,
            vanceHat2ImgElement, vanceFatImgElement, vanceChubbyImgElement
        ];
        const characterImages = [
            vanceHead2Img, vanceWithHatImg, vanceGirlImg, vanceSuitImg,
            vanceHat2Img, vanceFatImg, vanceChubbyImg
        ];

        function updateCharacterSelection() {
            characterOptions.forEach((option, index) => {
                option.parentElement.classList.toggle('selected', index === selectedCharacterIndex);
            });
        }

        function initCharacterSelectKeyboard() {
            updateCharacterSelection();
            document.addEventListener('keydown', handleCharacterSelectKeys);
        }

        function handleCharacterSelectKeys(e) {
            if (characterSelect.style.display !== 'flex') return;
            if (e.key === 'ArrowLeft') {
                selectedCharacterIndex = (selectedCharacterIndex - 1 + characterOptions.length) % characterOptions.length;
                hoverSound.play();
                updateCharacterSelection();
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                selectedCharacterIndex = (selectedCharacterIndex + 1) % characterOptions.length;
                hoverSound.play();
                updateCharacterSelection();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                selectedVanceImg = characterImages[selectedCharacterIndex];
                characterSelect.style.display = 'none';
                characterVideo.pause();
                selectSound.play();
                drawInitialScreen();
                startGame();
                document.removeEventListener('keydown', handleCharacterSelectKeys);
                e.preventDefault();
            }
            // Removed specific M key handling here since we now have global M key handling
        }

        vanceHead2ImgElement.addEventListener('mouseover', () => hoverSound.play());
        vanceHead2ImgElement.addEventListener('click', () => {
            selectedVanceImg = vanceHead2Img;
            characterSelect.style.display = 'none';
            characterVideo.pause();
            selectSound.play();
            drawInitialScreen();
            startGame();
        });

        vanceWithHatImgElement.addEventListener('mouseover', () => hoverSound.play());
        vanceWithHatImgElement.addEventListener('click', () => {
            selectedVanceImg = vanceWithHatImg;
            characterSelect.style.display = 'none';
            characterVideo.pause();
            selectSound.play();
            drawInitialScreen();
            startGame();
        });

        vanceGirlImgElement.addEventListener('mouseover', () => hoverSound.play());
        vanceGirlImgElement.addEventListener('click', () => {
            selectedVanceImg = vanceGirlImg;
            characterSelect.style.display = 'none';
            characterVideo.pause();
            selectSound.play();
            drawInitialScreen();
            startGame();
        });

        vanceSuitImgElement.addEventListener('mouseover', () => hoverSound.play());
        vanceSuitImgElement.addEventListener('click', () => {
            selectedVanceImg = vanceSuitImg;
            characterSelect.style.display = 'none';
            characterVideo.pause();
            selectSound.play();
            drawInitialScreen();
            startGame();
        });

        vanceHat2ImgElement.addEventListener('mouseover', () => hoverSound.play());
        vanceHat2ImgElement.addEventListener('click', () => {
            selectedVanceImg = vanceHat2Img;
            characterSelect.style.display = 'none';
            characterVideo.pause();
            selectSound.play();
            drawInitialScreen();
            startGame();
        });

        vanceFatImgElement.addEventListener('mouseover', () => hoverSound.play());
        vanceFatImgElement.addEventListener('click', () => {
            selectedVanceImg = vanceFatImg;
            characterSelect.style.display = 'none';
            characterVideo.pause();
            selectSound.play();
            drawInitialScreen();
            startGame();
        });

        vanceChubbyImgElement.addEventListener('mouseover', () => hoverSound.play());
        vanceChubbyImgElement.addEventListener('click', () => {
            selectedVanceImg = vanceChubbyImg;
            characterSelect.style.display = 'none';
            characterVideo.pause();
            selectSound.play();
            drawInitialScreen();
            startGame();
        });

        const keys = {};
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !gameActive && gameOverText) {
                resetGame();
                return;
            }
            if (!gameActive) return;
            keys[e.key] = true;
            if (e.key === 'p' && !levelTransition) {
                if (!gamePaused) {
                    gamePaused = true;
                    pauseBtn.disabled = true;
                    resumeBtn.disabled = false;
                    pauseSound.play();
                } else {
                    gamePaused = false;
                    pauseBtn.disabled = false;
                    resumeBtn.disabled = true;
                    resumedSound.play();
                    lastTime = performance.now();
                }
            }
            if (e.key.toLowerCase() === 'e' && currentPowerUp) {
                if (currentPowerUp === 'javelin') {
                    launchMissile();
                } else if (currentPowerUp === 'cybertruck') {
                    triggerCybertruckExplosion();
                }
            }
            if (e.key === ' ') shootLollipop();
        });
        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        document.body.addEventListener('touchstart', (e) => {
            if (!gameActive || gamePaused || levelTransition || characterSelect.style.display === 'flex') return;
            e.preventDefault();
            for (let touch of e.touches) {
                const touchX = touch.clientX;
                const touchY = touch.clientY;
                if (touchY > canvas.offsetTop && touchY < canvas.offsetTop + canvas.height) {
                    if (touchX < window.innerWidth / 3) {
                        touchLeft = true;
                    } else if (touchX > window.innerWidth * 2 / 3) {
                        touchRight = true;
                    }
                }
            }
        });

        document.body.addEventListener('touchmove', (e) => {
            if (!gameActive || gamePaused || levelTransition || characterSelect.style.display === 'flex') return;
            e.preventDefault();
            touchLeft = false;
            touchRight = false;
            for (let touch of e.touches) {
                const touchX = touch.clientX;
                const touchY = touch.clientY;
                if (touchY > canvas.offsetTop && touchY < canvas.offsetTop + canvas.height) {
                    if (touchX < window.innerWidth / 3) {
                        touchLeft = true;
                    } else if (touchX > window.innerWidth * 2 / 3) {
                        touchRight = true;
                    }
                }
            }
        });

        document.body.addEventListener('touchend', (e) => {
            if (!gameActive || gamePaused || levelTransition || characterSelect.style.display === 'flex') return;
            e.preventDefault();
            touchLeft = false;
            touchRight = false;
        });

        throwBtn.addEventListener('touchstart', (e) => {
            if (!gameActive || gamePaused || levelTransition) return;
            e.preventDefault();
            shootLollipop();
            throwBtn.classList.add('pressed');
            setTimeout(() => throwBtn.classList.remove('pressed'), 100);
        });

        powerUpBtn.addEventListener('touchstart', (e) => {
            if (!gameActive || gamePaused || levelTransition || !currentPowerUp) return;
            e.preventDefault();
            if (currentPowerUp === 'javelin') {
                launchMissile();
            } else if (currentPowerUp === 'cybertruck') {
                triggerCybertruckExplosion();
            }
            powerUpBtn.classList.add('pressed');
            setTimeout(() => powerUpBtn.classList.remove('pressed'), 100);
        });

        pauseBtn.addEventListener('click', () => {
            if (gameActive && !gamePaused && !levelTransition) {
                gamePaused = true;
                pauseBtn.disabled = true;
                resumeBtn.disabled = false;
                pauseSound.play();
            }
        });
        resumeBtn.addEventListener('click', () => {
            if (gameActive && gamePaused && !levelTransition) {
                gamePaused = false;
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                resumedSound.play();
                lastTime = performance.now();
            }
        });

        menuBtn.addEventListener('click', () => {
            if (gameActive) {
                returnToCharacterSelect();
            }
        });

        restartBtn.addEventListener('click', () => {
            resetGame();
        });

        characterSelectBtn.addEventListener('click', () => {
            returnToCharacterSelect();
        });

        function resizeCanvas() {
            const aspectRatio = 800 / 600;
            let newWidth = window.innerWidth * 0.9;
            let newHeight = newWidth / aspectRatio;

            if (newHeight > window.innerHeight * 0.8) {
                newHeight = window.innerHeight * 0.8;
                newWidth = newHeight * aspectRatio;
            }

            canvas.width = newWidth;
            canvas.height = newHeight;

            scaleFactor = canvas.width / BASE_CANVAS_WIDTH;

            player.speed = player.baseSpeed * scaleFactor;

            player.x = canvas.width / 2 - player.baseWidth / 2;
            player.displayWidth = player.baseWidth * scaleFactor * player.sizeMultiplier;
            player.displayHeight = player.baseHeight * scaleFactor * player.sizeMultiplier;
            player.targetWidth = player.baseWidth * scaleFactor * player.sizeMultiplier;
            player.targetHeight = player.baseHeight * scaleFactor * player.sizeMultiplier;

            zelenskyHeads.forEach(head => {
                head.displayWidth = 41 * scaleFactor;
                head.displayHeight = 61 * scaleFactor;
                head.speedX = (Math.random() - 0.5) * 2.5 * scaleFactor;
                head.speedY = (Math.random() - 0.5) * 2.5 * scaleFactor;
            });

            putinHeads.forEach(head => {
                if (head.isSmall) {
                    head.displayWidth = 20 * scaleFactor;
                    head.displayHeight = 30 * scaleFactor;
                } else {
                    head.displayWidth = 41 * scaleFactor;
                    head.displayHeight = 61 * scaleFactor;
                }
                head.speedX = head.speedX * scaleFactor / (head.isSmall ? 1 : 2.5);
                head.speedY = head.speedY * scaleFactor / (head.isSmall ? 1 : 2.5);
            });

            trumpHeads.forEach(head => {
                head.width = 100 * scaleFactor;
                head.height = 62 * scaleFactor;
                head.speedY = 2.5 * scaleFactor;
            });

            cybertrucks.forEach(truck => {
                truck.width = 60 * scaleFactor;
                truck.height = 30 * scaleFactor;
                truck.speedY = 2.5 * scaleFactor;
            });

            javelins.forEach(javelin => {
                javelin.width = 20 * scaleFactor;
                javelin.height = 60 * scaleFactor;
                javelin.speedY = 2.5 * scaleFactor;
            });

            if (missile) {
                missile.width = 90 * scaleFactor;
                missile.height = 45 * scaleFactor;
                missile.speed = 5 * scaleFactor;
            }

            lollipops.forEach(lollipop => {
                lollipop.width = 10 * 1.3 * scaleFactor;
                lollipop.height = 20 * 1.3 * scaleFactor;
                lollipop.speed = -6 * scaleFactor;
            });

            if (!gameActive) {
                // If on gamertag entry screen, redraw hallway background
                if (gamertagEntry.style.display === 'flex') {
                    drawHallwayBackground();
                }
                // Otherwise draw regular background
                else {
                    drawBackground();
                    if (characterSelect.style.display === 'none' && selectedVanceImg) {
                        drawInitialScreen();
                    }
                }
            } else {
                draw();
            }
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawInitialScreen() {
            drawBackground();
            if (selectedVanceImg && selectedVanceImg.complete) {
                ctx.drawImage(selectedVanceImg, player.x, canvas.height - player.displayHeight, player.displayWidth, player.displayHeight);
            }
        }

        function spawnZelenskyHeads(count) {
            zelenskyHeads = [];
            for (let i = 0; i < count; i++) {
                zelenskyHeads.push({
                    x: Math.random() * (canvas.width - 41 * scaleFactor),
                    y: Math.random() * (canvas.height / 2),
                    width: 41,
                    height: 61,
                    displayWidth: 41 * scaleFactor,
                    displayHeight: 61 * scaleFactor,
                    speedX: (Math.random() - 0.5) * 2.5 * scaleFactor,
                    speedY: (Math.random() - 0.5) * 2.5 * scaleFactor,
                    text: null,
                    textTimer: 0
                });
            }
        }

     function spawnPutinHead() {
    const padding = 100 * scaleFactor; // Increased padding to 100 units
    const minX = padding;
    const maxX = canvas.width - (41 * scaleFactor) - padding; // 41 is the width of big Putin
    const spawnX = minX + Math.random() * (maxX - minX);
    putinHeads.push({
        x: spawnX,
        y: Math.random() * (canvas.height / 2),
        width: 41,
        height: 61,
        displayWidth: 41 * scaleFactor,
        displayHeight: 61 * scaleFactor,
        speedX: (Math.random() - 0.5) * 2.5 * scaleFactor,
        speedY: (Math.random() - 0.5) * 2.5 * scaleFactor,
        text: "WWIII!",
        textTimer: Infinity,
        isSmall: false
    });
}

function spawnSmallPutinHeads(x, y, count) {
    const spread = 50 * scaleFactor;
    const minX = 0;
    const maxX = canvas.width - (24 * scaleFactor); // Updated to new width
    for (let i = 0; i < count; i++) {
        let spawnX = x + (Math.random() - 0.5) * spread;
        spawnX = Math.max(minX, Math.min(maxX, spawnX));
        putinHeads.push({
            x: spawnX,
            y: y,
            spawnY: y,
            width: 24,                // Increased from 20 to 24 (20% bigger)
            height: 36,               // Increased from 30 to 36 (20% bigger)
            displayWidth: 24 * scaleFactor,  // Updated to match new width
            displayHeight: 36 * scaleFactor, // Updated to match new height
            speedX: (Math.random() - 0.5) * 1 * scaleFactor,
            speedY: 0,
            gravity: 0.1 * scaleFactor,
            text: null,
            textTimer: 0,
            isSmall: true,
            hasLanded: false
        });
    }
}

        function spawnTrumpHead() {
            trumpHeads.push({
                x: Math.random() * (canvas.width - 100 * scaleFactor),
                y: -62 * scaleFactor,
                width: 100 * scaleFactor,
                height: 62 * scaleFactor,
                speedY: 2.5 * scaleFactor,
                text: "MAGA"
            });
            lastTrumpSpawnTime = Math.floor(timeLeft);
            trumpSpawnTimer = 30;
        }

        function spawnCybertruck() {
            cybertrucks.push({
                x: Math.random() * (canvas.width - 60 * scaleFactor),
                y: -30 * scaleFactor,
                width: 60 * scaleFactor,
                height: 30 * scaleFactor,
                speedY: 2.5 * scaleFactor,
            });
            lastCybertruckSpawnTime = Math.floor(timeLeft);
            cybertruckSpawnTimer = 25;
        }

        function spawnJavelin() {
            javelins.push({
                x: Math.random() * (canvas.width - 20 * scaleFactor),
                y: -60 * scaleFactor,
                width: 20 * scaleFactor,
                height: 60 * scaleFactor,
                speedY: 2.5 * scaleFactor,
            });
            lastJavelinSpawnTime = Math.floor(timeLeft);
            javelinSpawnTimer = 20;
        }

        function shootLollipop() {
            const lollipop = {
                x: player.x + (player.displayWidth - (10 * 1.3 * scaleFactor)) / 2,
                y: canvas.height - player.displayHeight,
                width: 10 * 1.3 * scaleFactor,
                height: 20 * 1.3 * scaleFactor,
                speed: -6 * scaleFactor,
            };
            lollipops.push(lollipop);
            player.text = "Say Pwease";
            player.textTimer = 1;
            shootSound.play();
        }

        function triggerCybertruckExplosion() {
            if (currentPowerUp === 'cybertruck') {
                player.explosion = {
                    x: player.x + player.displayWidth / 2,
                    y: canvas.height - player.displayHeight / 2,
                    baseWidth: 200 * scaleFactor,
                    baseHeight: 200 * scaleFactor,
                    width: 200 * scaleFactor,
                    height: 200 * scaleFactor,
                    timer: 2,
                    sizeTimer: 0.5
                };
                currentPowerUp = null;
                explosionSound.play();
            }
        }

        function launchMissile() {
            if (currentPowerUp === 'javelin') {
                missile = {
                    x: player.x + player.displayWidth / 2 - (90 * scaleFactor) / 2,
                    y: canvas.height - player.displayHeight,
                    width: 90 * scaleFactor,
                    height: 45 * scaleFactor,
                    speed: 5 * scaleFactor,
                    explosion: null,
                    lifetime: 3
                };
                currentPowerUp = null;
                missileLaunchSound.play();
                missileFlyingSound.loop = true;
                missileFlyingSound.play();
            }
        }

        function resetGameState(fullReset = false) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (gameTimer) clearInterval(gameTimer);

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('highScore', highScore);
                highScoreDisplay.textContent = `High Score: ${highScore}`;
            }

            level = 1;
            score = 0;
            timeLeft = 60;
            currentBackgroundIndex = 0;
            player.x = canvas.width / 2 - player.baseWidth / 2;
            player.displayWidth = player.baseWidth * scaleFactor;
            player.displayHeight = player.baseHeight * scaleFactor;
            player.targetWidth = player.baseWidth * scaleFactor;
            player.targetHeight = player.baseHeight * scaleFactor;
            player.speed = player.baseSpeed * scaleFactor;
            player.text = null;
            player.invincible = false;
            player.invincibleTimer = 0;
            player.sizeMultiplier = 1;
            player.sizeTransition = 1;
            player.explosion = null;
            lollipops = [];
            zelenskyHeads = [];
            putinHeads = [];
            trumpHeads = [];
            cybertrucks = [];
            javelins = [];
            missile = null;
            missileFlyingSound.pause();
            missileFlyingSound.currentTime = 0;
            textEffects = [];
            gamePaused = false;
            levelTransition = false;
            transitionTimer = 3;
            gibMoneyTimer = 0;
            trumpSpawnTimer = 30;
            cybertruckSpawnTimer = 25;
            javelinSpawnTimer = 20;
            lastTrumpSpawnTime = 60;
            lastCybertruckSpawnTime = 60;
            lastJavelinSpawnTime = 60;
            gameOverText = null;
            restartBtn.style.display = 'none';
            characterSelectBtn.style.display = 'none';
            touchLeft = false;
            touchRight = false;

            if (fullReset) {
                selectedVanceImg = null;
                gameActive = false;
                currentPowerUp = null;
            }
        }

        function resetGame() {
            resetGameState();
            gameActive = true;
            pauseBtn.disabled = false;
            resumeBtn.disabled = true;
            canvas.classList.remove('green-border');
            spawnZelenskyHeads(levels[0]);
            startGameTimer();
            lastTime = performance.now();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function returnToCharacterSelect() {
            resetGameState(true);
            drawBackground();
            setupCharacterVideo();
            characterSelect.style.display = 'flex';
            selectedCharacterIndex = 0;
            updateCharacterSelection();
            document.removeEventListener('keydown', handleCharacterSelectKeys);
            document.addEventListener('keydown', handleCharacterSelectKeys);
        }

        function startGameTimer() {
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(() => {
                if (gameActive && !gamePaused && !levelTransition && timeLeft > 0) {
                    timeLeft -= 1;
                } else if (timeLeft <= 0) {
                    gameActive = false;
                    clearInterval(gameTimer);
                    gameTimer = null;
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    gameOverText = 'Game Over! Time Up! Final Score: ' + score;
                    restartBtn.style.display = 'block';
                    characterSelectBtn.style.display = 'block';
                }
            }, 1000);
        }

        function startNextLevel() {
            levelTransition = true;
            transitionTimer = 3;
            canvas.classList.add('green-border');
            lollipops = [];
            zelenskyHeads = [];
            putinHeads = [];
            trumpHeads = [];
            cybertrucks = [];
            javelins = [];
            missile = null;
            missileFlyingSound.pause();
            missileFlyingSound.currentTime = 0;
            textEffects = [];
            trumpSpawnTimer = 30;
            cybertruckSpawnTimer = 25;
            javelinSpawnTimer = 20;
            lastTrumpSpawnTime = 60;
            lastCybertruckSpawnTime = 60;
            lastJavelinSpawnTime = 60;
            let countdown = setInterval(() => {
                transitionTimer--;
                timerSound.play();
                if (transitionTimer <= 0) {
                    clearInterval(countdown);
                    canvas.classList.remove('green-border');
                    timeLeft = 60;
                    player.width = player.baseWidth;
                    player.height = player.baseHeight;
                    player.displayWidth = player.baseWidth * scaleFactor;
                    player.displayHeight = player.baseHeight * scaleFactor;
                    player.targetWidth = player.baseWidth * scaleFactor;
                    player.targetHeight = player.baseHeight * scaleFactor;
                    player.x = canvas.width / 2 - player.baseWidth / 2;
                    player.speed = player.baseSpeed * scaleFactor;
                    player.text = null;
                    player.invincible = false;
                    player.invincibleTimer = 0;
                    player.sizeMultiplier = 1;
                    player.sizeTransition = 1;
                    player.explosion = null;
                    spawnZelenskyHeads(levels[level - 1]);
                    currentBackgroundIndex = (level - 1) % backgrounds.length;
                    levelTransition = false;
                    clapSound.play();
                }
            }, 1000);
        }

        function update() {
            if (!gameActive || gamePaused || levelTransition) return;

            if (!missile) {
                if (keys['ArrowLeft'] || keys['a']) {
                    player.x = Math.max(0, player.x - player.speed);
                }
                if (keys['ArrowRight'] || keys['d']) {
                    player.x = Math.min(canvas.width - player.displayWidth, player.x + player.speed);
                }
                if (touchLeft) {
                    player.x = Math.max(0, player.x - player.speed);
                }
                if (touchRight) {
                    player.x = Math.min(canvas.width - player.displayWidth, player.x + player.speed);
                }
            } else {
                if (keys['w']) missile.y -= missile.speed;
                if (keys['s']) missile.y += missile.speed;
                if (keys['a']) missile.x -= missile.speed;
                if (keys['d']) missile.x += missile.speed;

                missile.x = Math.max(0, Math.min(canvas.width - missile.width, missile.x));
                missile.y = Math.max(0, Math.min(canvas.height - missile.height, missile.y));

                missile.lifetime -= 1 / 60;
                if (missile.lifetime <= 0 && !missile.explosion) {
                    missile.explosion = {
                        x: missile.x + missile.width / 2,
                        y: missile.y + missile.height / 2,
                        baseWidth: 200 * scaleFactor,
                        baseHeight: 200 * scaleFactor,
                        width: 200 * scaleFactor,
                        height: 200 * scaleFactor,
                        timer: 2,
                        sizeTimer: 0.5
                    };
                    explosionSound.play();
                    missileFlyingSound.pause();
                    missileFlyingSound.currentTime = 0;
                }

                zelenskyHeads = zelenskyHeads.filter((head, index) => {
                    if (missile && missile.x < head.x + head.width &&
                        missile.x + missile.width > head.x &&
                        missile.y < head.y + head.height &&
                        missile.y + missile.height > head.y) {
                        missile.explosion = {
                            x: missile.x + missile.width / 2,
                            y: missile.y + missile.height / 2,
                            baseWidth: 200 * scaleFactor,
                            baseHeight: 200 * scaleFactor,
                            width: 200 * scaleFactor,
                            height: 200 * scaleFactor,
                            timer: 2,
                            sizeTimer: 0.5
                        };
                        explosionSound.play();
                        missileFlyingSound.pause();
                        missileFlyingSound.currentTime = 0;
                        score++;
                        textEffects.push({
                            x: head.x + head.width / 2,
                            y: head.y + head.height / 2,
                            text: "Thank You",
                            textTimer: 1
                        });
                        hitSoundPool[hitSoundIndex].play();
                        hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                        return false;
                    }
                    return true;
                });

                putinHeads = putinHeads.filter((head, index) => {
                    if (missile && missile.x < head.x + head.width &&
                        missile.x + missile.width > head.x &&
                        missile.y < head.y + head.height &&
                        missile.y + missile.height > head.y) {
                        missile.explosion = {
                            x: missile.x + missile.width / 2,
                            y: missile.y + missile.height / 2,
                            baseWidth: 200 * scaleFactor,
                            baseHeight: 200 * scaleFactor,
                            width: 200 * scaleFactor,
                            height: 200 * scaleFactor,
                            timer: 2,
                            sizeTimer: 0.5
                        };
                        explosionSound.play();
                        missileFlyingSound.pause();
                        missileFlyingSound.currentTime = 0;
                        score++;
                        textEffects.push({
                            x: head.x + head.width / 2,
                            y: head.y + head.height / 2,
                            text: "Thank You",
                            textTimer: 1
                        });
                        hitSoundPool[hitSoundIndex].play();
                        hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                        if (!head.isSmall) {
                            const splitCount = Math.min(2 + (level - 1) * 2, 20);
                            spawnSmallPutinHeads(head.x, head.y, splitCount);
                        }
                        return false;
                    }
                    return true;
                });

                if (missile && missile.explosion) {
                    missile.explosion.timer -= 1 / 60;
                    if (missile.explosion.sizeTimer > 0) {
                        missile.explosion.sizeTimer -= 1 / 60;
                        const t = missile.explosion.sizeTimer / 0.5;
                        missile.explosion.width = missile.explosion.baseWidth * (1 + (1 - t));
                        missile.explosion.height = missile.explosion.baseHeight * (1 + (1 - t));
                    } else {
                        missile.explosion.width = missile.explosion.baseWidth;
                        missile.explosion.height = missile.explosion.baseHeight;
                    }

                    zelenskyHeads = zelenskyHeads.filter(head => {
                        const dx = head.x + head.width / 2 - missile.explosion.x;
                        const dy = head.y + head.height / 2 - missile.explosion.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const explosionRadius = missile.explosion.width / 2;
                        if (distance < explosionRadius) {
                            score++;
                            textEffects.push({
                                x: head.x + head.width / 2,
                                y: head.y + head.height / 2,
                                text: "Thank You",
                                textTimer: 1
                            });
                            hitSoundPool[hitSoundIndex].play();
                            hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                            return false;
                        }
                        return true;
                    });

                    putinHeads = putinHeads.filter(head => {
                        const dx = head.x + head.width / 2 - missile.explosion.x;
                        const dy = head.y + head.height / 2 - missile.explosion.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const explosionRadius = missile.explosion.width / 2;
                        if (distance < explosionRadius) {
                            score++;
                            textEffects.push({
                                x: head.x + head.width / 2,
                                y: head.y + head.height / 2,
                                text: "Thank You",
                                textTimer: 1
                            });
                            hitSoundPool[hitSoundIndex].play();
                            hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                            if (!head.isSmall) {
                                const splitCount = Math.min(2 + (level - 1) * 2, 20);
                                spawnSmallPutinHeads(head.x, head.y, splitCount);
                            }
                            return false;
                        }
                        return true;
                    });

                    if (missile.explosion.timer <= 0) {
                        missile = null;
                    }
                }
            }

            lollipops.forEach((lollipop, index) => {
                lollipop.y += lollipop.speed;
                if (lollipop.y < 0) lollipops.splice(index, 1);
            });

            zelenskyHeads.forEach((head, index) => {
                head.x += head.speedX;
                head.y += head.speedY;

                if (head.x <= 0 || head.x >= canvas.width - head.width) head.speedX *= -1;
                if (head.y <= 0 || head.y >= canvas.height - head.height) head.speedY *= -1;

                if (!player.invincible &&
                    head.x < player.x + player.displayWidth &&
                    head.x + head.width > player.x &&
                    head.y < canvas.height &&
                    head.y + head.height > canvas.height - player.displayHeight) {
                    gameActive = false;
                    if (gameTimer) clearInterval(gameTimer);
                    gameTimer = null;
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    deadSound.play();
                    gameOverText = 'Game Over! Zelensky has your money! Final Score: ' + score;
                    restartBtn.style.display = 'block';
                    characterSelectBtn.style.display = 'block';
                    return;
                }
            });

 putinHeads.forEach((head, index) => {
    if (head.isSmall) {
        head.y += head.speedY;
        head.speedY += head.gravity;

        head.x += head.speedX;
        // Clamp position and reverse speed if hitting edges
        if (head.x <= 0) {
            head.x = 0;
            head.speedX = Math.abs(head.speedX); // Bounce right
        } else if (head.x >= canvas.width - head.displayWidth) {
            head.x = canvas.width - head.displayWidth;
            head.speedX = -Math.abs(head.speedX); // Bounce left
        }

        if (head.y >= canvas.height - head.height && !head.hasLanded) {
            head.y = canvas.height - head.height;
            head.speedY = -Math.sqrt(2 * head.gravity * (canvas.height - head.height - head.spawnY));
            head.hasLanded = true;
        } else if (head.hasLanded && head.y >= canvas.height - head.height) {
            head.y = canvas.height - head.height;
            head.speedY = -Math.sqrt(2 * head.gravity * (canvas.height - head.height - head.spawnY));
        }
        if (head.y < 0) head.y = 0;
    } else {
        head.x += head.speedX;
        head.y += head.speedY;

        // Clamp big Putin head position and reverse speed
        if (head.x <= 0) {
            head.x = 0;
            head.speedX = Math.abs(head.speedX); // Bounce right
        } else if (head.x >= canvas.width - head.displayWidth) {
            head.x = canvas.width - head.displayWidth;
            head.speedX = -Math.abs(head.speedX); // Bounce left
        }
        if (head.y <= 0 || head.y >= canvas.height - head.height) head.speedY *= -1;
    }

    if (!player.invincible &&
        head.x < player.x + player.displayWidth &&
        head.x + head.width > player.x &&
        head.y < canvas.height &&
        head.y + head.height > canvas.height - player.displayHeight) {
        gameActive = false;
        if (gameTimer) clearInterval(gameTimer);
        gameTimer = null;
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        deadSound.play();
        gameOverText = 'Game Over! Putin Started WWIII! Final Score: ' + score;
        restartBtn.style.display = 'block';
        characterSelectBtn.style.display = 'block';
        return;
    }
});

            trumpSpawnTimer -= 1 / 60;
            if (trumpSpawnTimer <= 0 && timeLeft > 0) {
                spawnTrumpHead();
            }

            cybertruckSpawnTimer -= 1 / 60;
            if (cybertruckSpawnTimer <= 0 && timeLeft > 0) {
                spawnCybertruck();
            }

            javelinSpawnTimer -= 1 / 60;
            if (javelinSpawnTimer <= 0 && timeLeft > 0) {
                spawnJavelin();
            }

            trumpHeads.forEach((head, index) => {
                head.y += head.speedY;
                if (head.y > canvas.height) trumpHeads.splice(index, 1);

                if (head.x < player.x + player.displayWidth &&
                    head.x + head.width > player.x &&
                    head.y < canvas.height &&
                    head.y + head.height > canvas.height - player.displayHeight) {
                    trumpHeads.splice(index, 1);
                    player.invincible = true;
                    player.invincibleTimer += 10;
                    player.sizeMultiplier *= 1.5;
                    player.targetWidth = player.baseWidth * scaleFactor * player.sizeMultiplier;
                    player.targetHeight = player.baseHeight * scaleFactor * player.sizeMultiplier;
                    player.sizeTransition = 0;
                    player.text = "I'M NOT YELLING!";
                    player.textTimer = 2;
                    enlargedSound.play();
                }
            });

            cybertrucks.forEach((truck, index) => {
                truck.y += truck.speedY;
                if (truck.y > canvas.height) cybertrucks.splice(index, 1);

                if (truck.x < player.x + player.displayWidth &&
                    truck.x + truck.width > player.x &&
                    truck.y < canvas.height &&
                    truck.y + truck.height > canvas.height - player.displayHeight) {
                    cybertrucks.splice(index, 1);
                    currentPowerUp = 'cybertruck';
                    itemSound.play();
                }
            });

            javelins.forEach((javelin, index) => {
                javelin.y += javelin.speedY;
                if (javelin.y > canvas.height) javelins.splice(index, 1);

                if (javelin.x < player.x + player.displayWidth &&
                    javelin.x + javelin.width > player.x &&
                    javelin.y < canvas.height &&
                    javelin.y + javelin.height > canvas.height - player.displayHeight) {
                    javelins.splice(index, 1);
                    currentPowerUp = 'javelin';
                    itemSound.play();
                }
            });

            if (player.explosion) {
                player.explosion.timer -= 1 / 60;
                if (player.explosion.sizeTimer > 0) {
                    player.explosion.sizeTimer -= 1 / 60;
                    const t = player.explosion.sizeTimer / 0.5;
                    player.explosion.width = player.explosion.baseWidth * (1 + (1 - t));
                    player.explosion.height = player.explosion.baseHeight * (1 + (1 - t));
                } else {
                    player.explosion.width = player.explosion.baseWidth;
                    player.explosion.height = player.explosion.baseHeight;
                }

                zelenskyHeads = zelenskyHeads.filter(head => {
                    const dx = head.x + head.width / 2 - player.explosion.x;
                    const dy = head.y + head.height / 2 - player.explosion.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const explosionRadius = player.explosion.width / 2;
                    if (distance < explosionRadius) {
                        score++;
                        textEffects.push({
                            x: head.x + head.width / 2,
                            y: head.y + head.height / 2,
                            text: "Thank You",
                            textTimer: 1
                        });
                        hitSoundPool[hitSoundIndex].play();
                        hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                        return false;
                    }
                    return true;
                });

                putinHeads = putinHeads.filter(head => {
                    const dx = head.x + head.width / 2 - player.explosion.x;
                    const dy = head.y + head.height / 2 - player.explosion.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const explosionRadius = player.explosion.width / 2;
                    if (distance < explosionRadius) {
                        score++;
                        textEffects.push({
                            x: head.x + head.width / 2,
                            y: head.y + head.height / 2,
                            text: "Thank You",
                            textTimer: 1
                        });
                        hitSoundPool[hitSoundIndex].play();
                        hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                        if (!head.isSmall) {
                            const splitCount = Math.min(2 + (level - 1) * 2, 20);
                            spawnSmallPutinHeads(head.x, head.y, splitCount);
                        }
                        return false;
                    }
                    return true;
                });

                if (player.explosion.timer <= 0) {
                    player.explosion = null;
                }
            }

            textEffects.forEach((effect, index) => {
                effect.textTimer -= 1 / 60;
                if (effect.textTimer <= 0) {
                    textEffects.splice(index, 1);
                }
            });

            lollipops.forEach((lollipop, lollipopIndex) => {
                zelenskyHeads.forEach((head, headIndex) => {
                    if (lollipop.x < head.x + head.width &&
                        lollipop.x + lollipop.width > head.x &&
                        lollipop.y < head.y + head.height &&
                        lollipop.y + lollipop.height > head.y) {
                        lollipops.splice(lollipopIndex, 1);
                        zelenskyHeads.splice(headIndex, 1);
                        score++;
                        textEffects.push({
                            x: head.x + head.width / 2,
                            y: head.y + head.height / 2,
                            text: "Thank You",
                            textTimer: 1
                        });
                        hitSoundPool[hitSoundIndex].play();
                        hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                        if (!player.invincible) {
                            player.displayWidth *= 1.02;
                            player.displayHeight *= 1.02;
                            player.sizeMultiplier *= 1.02;
                            player.targetWidth = player.displayWidth;
                            player.targetHeight = player.displayHeight;
                        }
                        if (zelenskyHeads.length === 0 && putinHeads.length === 0) {
                            spawnPutinHead();
                        }
                        return;
                    }
                });

                putinHeads.forEach((head, headIndex) => {
                    if (lollipop.x < head.x + head.width &&
                        lollipop.x + lollipop.width > head.x &&
                        lollipop.y < head.y + head.height &&
                        lollipop.y + lollipop.height > head.y) {
                        lollipops.splice(lollipopIndex, 1);
                        score++;
                        textEffects.push({
                            x: head.x + head.width / 2,
                            y: head.y + head.height / 2,
                            text: "Thank You",
                            textTimer: 1
                        });
                        hitSoundPool[hitSoundIndex].play();
                        hitSoundIndex = (hitSoundIndex + 1) % hitSoundPool.length;
                        if (!head.isSmall) {
                            const splitCount = Math.min(2 + (level - 1) * 2, 20);
                            spawnSmallPutinHeads(head.x, head.y, splitCount);
                            putinHeads.splice(headIndex, 1);
                        } else {
                            putinHeads.splice(headIndex, 1);
                        }
                        return;
                    }
                });
            });

      if (zelenskyHeads.length === 0 && putinHeads.length === 0 && level <= 10 && !levelTransition) {
    level++;
    if (level > 10) {
        gameActive = false;
        if (gameTimer) clearInterval(gameTimer);
        gameTimer = null;
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        gameOverText = 'You Won! No Questions Pwease!';
        restartBtn.style.display = 'none';
        characterSelectBtn.style.display = 'block';
    } else {
        startNextLevel();
    }
}

            if (player.invincible) {
                player.invincibleTimer -= 1 / 60;
                if (player.sizeTransition < 1) {
                    player.sizeTransition += 1 / (60 * player.sizeTransitionSpeed);
                    if (player.sizeTransition > 1) player.sizeTransition = 1;
                    const t = easeInOut(player.sizeTransition);
                    player.displayWidth = (player.baseWidth * scaleFactor) + (player.targetWidth - (player.baseWidth * scaleFactor)) * t;
                    player.displayHeight = (player.baseHeight * scaleFactor) + (player.targetHeight - (player.baseHeight * scaleFactor)) * t;
                }
                if (player.invincibleTimer <= 0) {
                    player.invincible = false;
                    player.targetWidth = player.baseWidth * scaleFactor;
                    player.targetHeight = player.baseHeight * scaleFactor;
                    player.sizeTransition = 0;
                }
            } else if (player.displayWidth > player.targetWidth && player.sizeTransition < 1) {
                player.sizeTransition += 1 / (60 * player.sizeTransitionSpeed);
                if (player.sizeTransition > 1) player.sizeTransition = 1;
                const t = easeInOut(player.sizeTransition);
                player.displayWidth = player.targetWidth + ((player.baseWidth * scaleFactor * player.sizeMultiplier) - player.targetWidth) * (1 - t);
                player.displayHeight = player.targetHeight + ((player.baseHeight * scaleFactor * player.sizeMultiplier) - player.targetHeight) * (1 - t);
                if (player.displayWidth < player.baseWidth * scaleFactor) {
                    player.displayWidth = player.baseWidth * scaleFactor;
                    player.displayHeight = player.baseHeight * scaleFactor;
                }
            }

            if (player.textTimer > 0) {
                player.textTimer -= 1 / 60;
                if (player.textTimer <= 0) player.text = null;
            }

            gibMoneyTimer += 1 / 60;
            if (gibMoneyTimer >= 5) {
                zelenskyHeads.forEach(head => {
                    head.text = "Gib Money";
                    head.textTimer = 1;
                });
                gibMoneyTimer = 0;
            }
            zelenskyHeads.forEach(head => {
                if (head.textTimer > 0) {
                    head.textTimer -= 1 / 60;
                    if (head.textTimer <= 0) head.text = null;
                }
            });
        }

        function draw() {
            if (levelTransition) {
                const flash = Math.floor(transitionTimer * 4) % 2 === 0;
                ctx.fillStyle = flash ? 'rgba(255, 0, 0, 0.5)' : 'rgba(255, 0, 0, 0)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            drawBackground();

            if (player.invincible) {
                if (player.invincibleTimer <= 3) {
                    const flash = Math.floor(player.invincibleTimer * 4) % 2 === 0;
                    ctx.shadowColor = flash ? 'red' : 'transparent';
                    ctx.shadowBlur = flash ? 20 : 0;
                } else {
                    ctx.shadowColor = 'red';
                    ctx.shadowBlur = 20;
                }
            }
            ctx.drawImage(selectedVanceImg, player.x, canvas.height - player.displayHeight, player.displayWidth, player.displayHeight);
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            if (player.text) {
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.font = `${20 * scaleFactor}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(player.text, player.x + player.displayWidth / 2, canvas.height - player.displayHeight - 10 * scaleFactor);
                ctx.shadowBlur = 0;
            }

            if (player.explosion) {
                const x = player.explosion.x - player.explosion.width / 2;
                const y = player.explosion.y - player.explosion.height / 2;
                ctx.drawImage(explosionImg, x, y, player.explosion.width, player.explosion.height);
            }

            lollipops.forEach(lollipop => {
                ctx.drawImage(lollipopImg, lollipop.x, lollipop.y, lollipop.width, lollipop.height);
            });

            zelenskyHeads.forEach(head => {
                ctx.drawImage(zelenskyImg, head.x, head.y, head.displayWidth, head.displayHeight);
                if (head.text) {
                    ctx.fillStyle = 'white';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.font = `${16 * scaleFactor}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(head.text, head.x + head.displayWidth / 2, head.y - 10 * scaleFactor);
                    ctx.shadowBlur = 0;
                }
            });

            putinHeads.forEach(head => {
                ctx.drawImage(putinImg, head.x, head.y, head.displayWidth, head.displayHeight);
                if (head.text) {
                    ctx.fillStyle = 'white';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.font = `${16 * scaleFactor}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(head.text, head.x + head.displayWidth / 2, head.y - 10 * scaleFactor);
                    ctx.shadowBlur = 0;
                }
            });

            trumpHeads.forEach(head => {
                ctx.drawImage(trumpImg, head.x, head.y, head.width, head.height);
                if (head.text) {
                    ctx.fillStyle = 'white';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.font = `${16 * scaleFactor}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(head.text, head.x + head.width / 2, head.y - 10 * scaleFactor);
                    ctx.shadowBlur = 0;
                }
            });

            cybertrucks.forEach(truck => {
                ctx.drawImage(cybertruckImg, truck.x, truck.y, truck.width, truck.height);
            });

            javelins.forEach(javelin => {
                ctx.drawImage(javelinImg, javelin.x, javelin.y, javelin.width, javelin.height);
            });

            if (currentPowerUp === 'cybertruck') {
                ctx.drawImage(cybertruckImg, canvas.width - 60 * scaleFactor, canvas.height - 30 * scaleFactor, 60 * scaleFactor, 30 * scaleFactor);
            } else if (currentPowerUp === 'javelin') {
                ctx.drawImage(javelinImg, canvas.width - 40 * scaleFactor, canvas.height - 60 * scaleFactor, 20 * scaleFactor, 60 * scaleFactor);
            }

            if (missile) {
                ctx.drawImage(missileImg, missile.x, missile.y, missile.width, missile.height);
            }

            if (missile && missile.explosion) {
                const x = missile.explosion.x - missile.explosion.width / 2;
                const y = missile.explosion.y - missile.explosion.height / 2;
                ctx.drawImage(explosionImg, x, y, missile.explosion.width, missile.explosion.height);
            }

            textEffects.forEach(effect => {
                if (effect.textTimer > 0) {
                    ctx.fillStyle = 'white';
                    ctx.shadowColor = 'black';
                    ctx.shadowBlur = 4;
                    ctx.font = `${16 * scaleFactor}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(effect.text, effect.x, effect.y - 10 * scaleFactor);
                    ctx.shadowBlur = 0;
                }
            });

            if (levelTransition) {
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.font = `${40 * scaleFactor}px Arial`;
                ctx.textAlign = 'center';
                const timerText = transitionTimer === 3 ? "3, 2, 1" : transitionTimer === 2 ? "2, 1" : "1";
                ctx.fillText(timerText, canvas.width / 2, canvas.height / 2);
                ctx.shadowBlur = 0;
            }

            if (gameOverText) {
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.font = `${30 * scaleFactor}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(gameOverText, canvas.width / 2, canvas.height / 2);
                ctx.shadowBlur = 0;
            }
            
            // Draw gamertag directly on the canvas
            if (playerGamertag) {
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.font = `${18 * scaleFactor}px Arial`;
                ctx.textAlign = 'left';
                ctx.fillText(playerGamertag, 10, 30);
                ctx.shadowBlur = 0;
            }

            document.getElementById('level').textContent = `Level: ${level}`;
            document.getElementById('score').textContent = `Score: ${score}`;
            document.getElementById('timer').textContent = `Timer: ${Math.floor(timeLeft)}`;
            highScoreDisplay.textContent = `High Score: ${highScore}`;
        }

        let lastTime = performance.now();
        function gameLoop(time) {
            if (!gameActive || gamePaused || (levelTransition && transitionTimer > 0)) {
                draw();
                animationFrameId = requestAnimationFrame(gameLoop);
                return;
            }

            const delta = (time - lastTime) / 1000;
            lastTime = time;

            update();
            draw();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startGame() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (gameTimer) clearInterval(gameTimer);

            // We don't need to update the playerGamertagDisplay anymore since we're
            // drawing directly on the canvas
            // playerGamertagDisplay.textContent = playerGamertag;

            gameActive = true;
            spawnZelenskyHeads(levels[0]);
            startGameTimer();
            lastTime = performance.now();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Initially hide characterSelect and show gamertag entry first
        characterSelect.style.display = 'none';
    </script>
</body>
</html>
